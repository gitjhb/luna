# Mio → Luna 功能迁移计划

## 概述

Mio 是 Telegram 轻量级 demo，Luna 是完整产品。目标：把 Mio 验证过的好功能迁移到 Luna backend。

---

## 功能对比

| 功能 | Mio (JS) | Luna (Python) | 迁移建议 |
|------|----------|---------------|----------|
| **记忆系统** | memory-v2/ (pgvector) ✅ | memory_manager.py | ✅ **已迁移** - pgvector 语义搜索已加入 |
| **情感记忆** | emotional-memory.js | emotion_engine_v2/ | ⚠️ **对比后决定** - 两边实现不同 |
| **亲密度** | intimacy.js (350行) | intimacy_service.py (50K行) | ❌ **Luna更完整** |
| **游戏系统** | games.js (583行) | game_engine.py (25K行) | ❌ **Luna更完整** |
| **用户画像提取** | profile-extractor.js | memory_manager.py | ⚠️ **可参考** - Mio的模式匹配更简洁 |
| **主动消息** | proactive.js | ❌ 无 | 🔴 **需迁移** |
| **故事模式** | story-mode.js | ❌ 无 | 🟡 **可选迁移** |
| **用户学习** | user-learning.js | ❌ 无 | 🟡 **可选迁移** |
| **里程碑** | milestones.js | milestones服务(存在) | ⚠️ **对比后决定** |
| **语音流** | voice-flow.js | voice service | ⚠️ **对比后决定** |
| **对话状态** | state.js | chat_service.py | ❌ **Luna更完整** |
| **支付** | payment.js | payment_service.py | ❌ **Luna更完整** |

---

## 🔴 必须迁移 (P0)

### 1. 主动消息系统 (proactive.js → Luna)

**Mio 实现：**
```javascript
// 触发条件
- 用户超过 X 小时未回复 → 发送想念消息
- 特殊日期（生日、纪念日）→ 发送祝福
- 早安/晚安时间 → 发送问候
```

**Luna 缺失：** 完全没有主动触达能力

**迁移方案：**
```python
# app/services/proactive_service.py
class ProactiveService:
    async def check_and_send(self, user_id: str):
        # 1. 检查用户最后活跃时间
        # 2. 检查今天是否特殊日期
        # 3. 检查当前时段
        # 4. 生成并发送主动消息
```

**工作量：** 4-6 小时

---

## 🟡 建议迁移 (P1)

### 2. 故事模式 (story-mode.js)

**Mio 实现：**
- 选择故事类型（约会、探险、情感）
- 分支剧情
- 记录故事进度

**Luna 情况：** 有 `interactive_date_service.py` 但逻辑不同

**迁移价值：** 增加互动玩法，提升付费转化

**工作量：** 6-8 小时

---

### 3. 用户学习系统 (user-learning.js)

**Mio 实现：**
```javascript
// 从对话中学习
- 用户沟通风格（幽默/严肃/简短/详细）
- 回复偏好时间
- 话题兴趣图谱
```

**Luna 情况：** memory_manager 有基础，但不够深

**迁移价值：** 让 AI 更懂用户，提升留存

**工作量：** 4-6 小时

---

## ⚠️ 需对比决定 (P2)

### 4. 情感记忆 (emotional-memory.js vs emotion_engine_v2)

**Mio：** 
- 轻量，专注记录情感高点/低点
- 用 Redis 存储

**Luna：**
- 复杂，有完整情绪引擎
- 用 PostgreSQL

**建议：** 保留 Luna 的完整系统，但参考 Mio 的简洁设计

---

### 5. 用户画像提取 (profile-extractor.js)

**Mio 优势：**
```javascript
// 正则快速匹配
INFO_PATTERNS = {
  name: [/我叫(.+)/, /叫我(.+)/],
  birthday: [/我的?生日是?(.+)/],
  occupation: [/我是做(.+)的/],
  likes: [/我喜欢(.+)/, /我爱(.+)/],
}
```

**建议：** 把这些 patterns 加入 Luna 的 memory_manager

---

## 迁移优先级

| 优先级 | 功能 | 理由 | 时间 |
|--------|------|------|------|
| **P0** | 主动消息 | 用户留存核心 | 4-6h |
| **P1** | 故事模式 | 付费转化 | 6-8h |
| **P1** | 用户学习 | 体验差异化 | 4-6h |
| **P2** | 画像提取优化 | 记忆准确度 | 2h |

**Total: 16-22 小时**

---

## 下一步

1. JHB 确认优先级
2. 逐个模块迁移
3. 测试验证
4. 部署上线

---

*Generated by Nikki @ 2026-02-22*
