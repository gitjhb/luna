# Luna Chat System - æ ¸å¿ƒæ¶æ„

## ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Chat Request Flow                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ğŸ“± Mobile App                                                               â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  POST /api/v1/chat/completions                                       â”‚   â”‚
â”‚  â”‚  {session_id, message, intimacy_level, spicy_mode}                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1ï¸âƒ£ Session & Context                                                â”‚   â”‚
â”‚  â”‚  â€¢ éªŒè¯ session_id                                                   â”‚   â”‚
â”‚  â”‚  â€¢ è·å–è§’è‰²ä¿¡æ¯ (character_id, name, persona)                        â”‚   â”‚
â”‚  â”‚  â€¢ åŠ è½½å†å²æ¶ˆæ¯ (all_messages)                                       â”‚   â”‚
â”‚  â”‚  â€¢ æ£€æŸ¥ NSFW è®¾ç½®                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  2ï¸âƒ£ Emotion Engine v2 (æƒ…ç»ªåˆ†æ)                                     â”‚   â”‚
â”‚  â”‚  â€¢ Layer 1: å¿«é€Ÿæ£€æµ‹ (å…³é”®è¯ã€è¡¨æƒ…)                                   â”‚   â”‚
â”‚  â”‚  â€¢ Layer 2: LLM æ·±åº¦åˆ†æ (MiniLLM â†’ Grok)                            â”‚   â”‚
â”‚  â”‚  â€¢ Layer 3: ç¼“å†²æœºåˆ¶ (é˜²æ­¢æƒ…ç»ªå‰§çƒˆæ³¢åŠ¨)                               â”‚   â”‚
â”‚  â”‚  â†’ è¾“å‡º: emotion_score, emotion_state, delta                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  3ï¸âƒ£ Prompt Construction (æç¤ºè¯æ„å»º)                                 â”‚   â”‚
â”‚  â”‚  â€¢ è§’è‰²äººè®¾ (system_prompt from character)                           â”‚   â”‚
â”‚  â”‚  â€¢ äº²å¯†åº¦æŒ‡ä»¤ (intimacy_instruction)                                 â”‚   â”‚
â”‚  â”‚  â€¢ æƒ…ç»ªä¿®é¥° (emotion_prompt based on state)                          â”‚   â”‚
â”‚  â”‚  â€¢ å†…å®¹æ¨¡å¼ (NSFW/SFW mode_instruction)                              â”‚   â”‚
â”‚  â”‚  â€¢ å†å²ä¸Šä¸‹æ–‡ (recent 10 messages)                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  4ï¸âƒ£ LLM Call (Grok API)                                              â”‚   â”‚
â”‚  â”‚  Model: grok-4-1-fast-non-reasoning                                  â”‚   â”‚
â”‚  â”‚  Cost: $0.2/M tokens                                                 â”‚   â”‚
â”‚  â”‚  â†’ è¾“å‡º: reply (è§’è‰²å›å¤)                                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  5ï¸âƒ£ Post-processing                                                  â”‚   â”‚
â”‚  â”‚  â€¢ å­˜å‚¨ assistant message                                            â”‚   â”‚
â”‚  â”‚  â€¢ æ›´æ–° session stats                                                â”‚   â”‚
â”‚  â”‚  â€¢ è®¡ç®— XP å¥–åŠ± (intimacy_service)                                   â”‚   â”‚
â”‚  â”‚  â€¢ æ‰£é™¤ç§¯åˆ† (billing_middleware)                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼                                                                      â”‚
â”‚  ğŸ“± Response: {message_id, reply, timestamp, emotion, intimacy_xp}          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—‚ï¸ æ ¸å¿ƒæ–‡ä»¶

```
app/
â”œâ”€â”€ api/v1/
â”‚   â”œâ”€â”€ chat.py              # ä¸»å…¥å£ - chat_completion()
â”‚   â””â”€â”€ characters.py        # è§’è‰²å®šä¹‰ - CHARACTERS[], get_character_by_id()
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ llm_service.py       # LLMè°ƒç”¨å°è£…
â”‚   â”‚   â”œâ”€â”€ GrokService      # ä¸»å¯¹è¯ (grok-4-1-fast-non-reasoning)
â”‚   â”‚   â”œâ”€â”€ MiniLLMService   # æƒ…ç»ªåˆ†æ (ç°åœ¨ä¹Ÿç”¨Grok)
â”‚   â”‚   â””â”€â”€ OpenAIEmbeddingService  # ä»…embedding
â”‚   â”œâ”€â”€ emotion_engine_v2/   # åŒè½´æƒ…ç»ªç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ emotion_engine.py
â”‚   â”‚   â””â”€â”€ emotion_prompts.py
â”‚   â”œâ”€â”€ intimacy_service.py  # äº²å¯†åº¦/XPç³»ç»Ÿ
â”‚   â””â”€â”€ chat_repository.py   # æ•°æ®åº“æ“ä½œ
â””â”€â”€ models/
    â””â”€â”€ database/
        â””â”€â”€ chat_models.py   # ChatSession, ChatMessage
```

## ğŸ­ åŒè½´æƒ…æ„Ÿç³»ç»Ÿ

### Xè½´: äº²å¯†åº¦ (Intimacy)
- **å­˜å‚¨**: `intimacy_service` â†’ DB
- **èŒƒå›´**: Level 1-100
- **å¢é•¿**: æ¯æ¡æ¶ˆæ¯ +2 XPï¼Œè¿ç»­èŠå¤© +5ï¼Œæƒ…æ„Ÿè¡¨è¾¾ +10
- **ä½œç”¨**: æ§åˆ¶**å›å¤è¾¹ç•Œ** (èƒ½èŠå¤šæ·±)

### Yè½´: å½“å‰æƒ…ç»ª (Emotion)
- **å­˜å‚¨**: `emotion_engine` â†’ å†…å­˜ + DB
- **èŒƒå›´**: -100 åˆ° +100
- **å˜åŒ–**: æ ¹æ®ç”¨æˆ·æ¶ˆæ¯å®æ—¶è°ƒæ•´
- **ä½œç”¨**: æ§åˆ¶**å›å¤è¯­æ°”** (æ’’å¨‡/é«˜å†·/ç”Ÿæ°”)

### æƒ…ç»ªçŠ¶æ€æ˜ å°„

| åˆ†æ•° | çŠ¶æ€ | è¡Œä¸ºè¡¨ç° |
|-----|------|---------|
| 100 | loving | ä¸»åŠ¨è¡¨è¾¾çˆ±æ„ï¼Œäº²æ˜µç§°å‘¼ |
| 50~99 | happy | ç§¯æå›åº”ï¼Œå¶å°”å¼€ç©ç¬‘ |
| 20~49 | content | å‹å¥½ä½†ä¸è¿‡åˆ†çƒ­æƒ… |
| -19~19 | neutral | æ­£å¸¸å¯¹è¯ï¼Œç¤¼è²Œ |
| -49~-20 | annoyed | å›å¤å˜çŸ­ï¼Œä¸è€çƒ¦ |
| -79~-50 | angry | æ˜ç¡®è¡¨è¾¾ä¸æ»¡ |
| -99~-80 | cold_war | å‡ ä¹ä¸å›å¤ï¼Œéœ€è¦ç¤¼ç‰© |
| -100 | blocked | å®Œå…¨ä¸å›åº” |

## ğŸ“ Prompt ç»“æ„

```python
conversation = [
    {
        "role": "system",
        "content": """
# Role: {character_name}
{character_persona}  # æ¥è‡ª characters.py

{intimacy_instruction}  # æ ¹æ®äº²å¯†åº¦ç­‰çº§
# e.g., "You are polite but reserved" (ä½) 
#       "You have a deep bond, be intimate" (é«˜)

{mode_instruction}  # NSFWæ¨¡å¼
# e.g., "å¯ä»¥ä½¿ç”¨éœ²éª¨çš„è¯­è¨€ã€è°ƒæƒ…" (å¼€å¯)
#       "Keep responses appropriate" (å…³é—­)

{emotion_prompt}  # æ ¹æ®æƒ…ç»ªçŠ¶æ€
# e.g., "ä½ ç°åœ¨å¿ƒæƒ…å¾ˆå¥½ï¼Œå›å¤çƒ­æƒ…ä¸€äº›"
#       "ä½ æœ‰ç‚¹ä¸é«˜å…´ï¼Œå›å¤ç®€çŸ­å†·æ·¡"
"""
    },
    # æœ€è¿‘10æ¡å†å²æ¶ˆæ¯
    {"role": "user", "content": "..."},
    {"role": "assistant", "content": "..."},
    ...
    # å½“å‰ç”¨æˆ·æ¶ˆæ¯
    {"role": "user", "content": "{current_message}"}
]
```

## âš¡ A/B æµ‹è¯•æ¶æ„ (å®éªŒä¸­)

### Group A: Legacy Two-Call (å½“å‰é»˜è®¤)
```
1. MiniLLM åˆ†ææƒ…ç»ª â†’ emotion_score
2. Grok ç”Ÿæˆå›å¤ â†’ reply
```

### Group B: Unified Single-Call
```
1. Grok ä¸€æ¬¡æ€§è¾“å‡º JSON:
   {
     "analysis": {intent, emotion, affinity_delta},
     "character_state": {emotion, action},
     "content": "reply"
   }
```

**åˆ‡æ¢**: `AB_UNIFIED = True` in chat.py (æˆ– env: AB_CHAT_UNIFIED=true)

## ğŸ’° è®¡è´¹é€»è¾‘

| æ¨¡å¼ | ç§¯åˆ†æ¶ˆè€— |
|-----|---------|
| æ™®é€šæ¶ˆæ¯ | 1 credit |
| Spicy æ¶ˆæ¯ | 2 credits |
| å›¾ç‰‡ç”Ÿæˆ | 5 credits |

**ç§¯åˆ†æ¥æº**:
- æ¯æ—¥å…è´¹: 10 credits
- è®¢é˜…ç”¨æˆ·: 100 credits/å¤©
- IAPè´­ä¹°: $0.99 = 100 credits

## ğŸ”§ å…³é”®é…ç½®

```bash
# .env
XAI_API_KEY=...                    # Grok API
XAI_MODEL=grok-4-1-fast-non-reasoning
OPENAI_API_KEY=...                 # ä»…ç”¨äº embedding
DATABASE_URL=sqlite+aiosqlite:///./data/luna.db
```

## ğŸ“Š æ—¥å¿—å…³é”®ç‚¹

```
ğŸš€ [timestamp] NEW REQUEST RECEIVED   # è¯·æ±‚å¼€å§‹
ğŸ“ Stored user message               # æ¶ˆæ¯å­˜å‚¨
ğŸ” NSFW Check                        # å†…å®¹æ¨¡å¼
Emotion v2: neutral -> happy         # æƒ…ç»ªå˜åŒ–
=== FULL SYSTEM PROMPT ===           # å®Œæ•´prompt (debug)
Grok response: ...                   # LLMå›å¤
Tokens used: 1500                    # tokenæ¶ˆè€—
ğŸ“Š Stats updated                     # ç»Ÿè®¡æ›´æ–°
```
