# 🧠 Memory System v2 - 分层记忆系统

## 架构概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Memory System v2                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │        Layer 1: 工作记忆 (Working Memory)                            │   │
│  │                                                                      │   │
│  │   当前对话的短期记忆，直接放入 LLM context                           │   │
│  │                                                                      │   │
│  │   [msg1] → [msg2] → [msg3] → ... → [msg15]                          │   │
│  │                                                                      │   │
│  │   容量: 10-20 条消息 | 生命周期: 当前会话                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │        Layer 2: 情节记忆 (Episodic Memory)                           │   │
│  │                                                                      │   │
│  │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐               │   │
│  │   │ 💕 表白 │  │ 💔 吵架 │  │ 🎉 纪念 │  │ 🎁 礼物 │               │   │
│  │   │ ⭐⭐⭐⭐│  │ ⭐⭐⭐  │  │ ⭐⭐⭐⭐│  │ ⭐⭐    │               │   │
│  │   │ 强度:1.0│  │ 强度:0.8│  │ 强度:1.0│  │ 强度:0.6│               │   │
│  │   └─────────┘  └─────────┘  └─────────┘  └─────────┘               │   │
│  │                                                                      │   │
│  │   容量: 50-100 条精选 | 生命周期: 永久（会衰减）                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │        Layer 3: 语义记忆 (Semantic Memory)                           │   │
│  │                                                                      │   │
│  │   ┌─────────────────────────────────────────────────────────────┐  │   │
│  │   │  用户档案                                                    │  │   │
│  │   │  ├── 基本: 名字=小明, 生日=2月14日, 职业=程序员             │  │   │
│  │   │  ├── 喜好: 猫, 动漫, 拉面 | 不喜欢: 香菜, 加班             │  │   │
│  │   │  ├── 关系: 昵称=宝贝, 纪念日=3月15日                        │  │   │
│  │   │  └── 敏感: 避免提及前任                                     │  │   │
│  │   └─────────────────────────────────────────────────────────────┘  │   │
│  │                                                                      │   │
│  │   容量: 无限（结构化） | 生命周期: 永久                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 文件结构

```
memory_system_v2/
├── __init__.py              # 模块导出
├── memory_manager.py        # 核心管理器 (600+ 行)
├── memory_prompts.py        # Prompt 生成 (300+ 行)
├── memory_models.py         # 数据库模型 (200+ 行)
└── integration_example.py   # 集成示例
```

## 快速集成

### 1. 在 chat_completion 中使用

```python
from memory_system_v2 import memory_manager, memory_prompt_generator

async def chat_completion(request, session):
    user_id = get_user_id(request)
    character_id = session["character_id"]
    
    # 获取工作记忆
    working_memory = await get_recent_messages(session_id, limit=15)
    
    # 获取记忆上下文
    memory_context = await memory_manager.get_memory_context(
        user_id=user_id,
        character_id=character_id,
        current_message=request.message,
        working_memory=working_memory,
    )
    
    # 生成记忆 prompt
    memory_prompt = memory_prompt_generator.generate(
        semantic_memory=memory_context.user_profile.__dict__,
        episodic_memories=[ep.__dict__ for ep in memory_context.relevant_episodes],
        current_query=request.message,
        intimacy_level=intimacy_level,
    )
    
    # 构建 system prompt
    system_prompt = f"""你是 {character_name}...

{memory_prompt}
"""
    
    # 调用 LLM...
    reply = await call_llm(system_prompt, working_memory, request.message)
    
    # 处理完成后，提取并存储记忆
    await memory_manager.process_conversation(
        user_id=user_id,
        character_id=character_id,
        user_message=request.message,
        assistant_response=reply,
        context=working_memory,
    )
    
    return reply
```

### 2. 定时任务：记忆衰减

```python
# 每日运行
async def daily_memory_decay():
    for user_id, character_id in active_pairs:
        await memory_manager.apply_memory_decay(
            user_id, character_id, days_passed=1.0
        )
```

## 核心功能

### 自动提取记忆

```python
# 用户说: "我叫小明，是个程序员，喜欢猫"

# 系统自动提取:
semantic_updates = {
    "user_name": "小明",
    "occupation": "程序员",
    "likes": ["猫"],
}
```

### 重要事件检测

| 事件类型 | 触发词 | 重要性 |
|---------|--------|--------|
| confession | 我爱你、喜欢你 | ⭐⭐⭐⭐ CRITICAL |
| fight | 分手、讨厌你、滚 | ⭐⭐⭐ HIGH |
| reconciliation | 对不起、原谅我 | ⭐⭐⭐ HIGH |
| milestone | 一周年、第一次 | ⭐⭐⭐⭐ CRITICAL |
| gift | 送你、礼物 | ⭐⭐ MEDIUM |

### 记忆衰减机制

```
记忆强度随时间衰减:

初始:  ████████████████████ 1.0
1周后: ██████████████████░░ 0.9  (重要记忆)
1周后: ████████████████░░░░ 0.8  (普通记忆)
1月后: ██████████████░░░░░░ 0.7  (重要记忆)
1月后: ████████░░░░░░░░░░░░ 0.4  (普通记忆)

规则:
- CRITICAL (4): 每天衰减 1%
- HIGH (3): 每天衰减 2%
- MEDIUM (2): 每天衰减 3%
- LOW (1): 每天衰减 5%
- 被回忆时 +10% 强度
```

## 与情绪系统联动

```
┌─────────────────────────────────────────────────────────────┐
│                    完整对话流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  用户消息 ──┬──► 情绪引擎 ──► 更新情绪分数                  │
│             │                                                │
│             └──► 记忆系统 ──► 提取/检索记忆                  │
│                      │                                       │
│                      ▼                                       │
│              ┌─────────────┐                                │
│              │ 构建 Prompt │                                │
│              │ • 角色设定  │                                │
│              │ • 情绪指令  │ ◄── emotion_prompt            │
│              │ • 记忆上下文│ ◄── memory_prompt             │
│              └──────┬──────┘                                │
│                     ▼                                        │
│                 调用 LLM ──► AI 回复                        │
│                     │                                        │
│                     └──────► 存储新记忆                      │
└─────────────────────────────────────────────────────────────┘
```

## 使用场景示例

### 场景 1: 第一次告诉名字
```
用户: 我叫小明
系统: 提取 user_name = "小明" → 存储
AI: "小明，很高兴认识你！"
之后: AI 会用 "小明" 称呼用户
```

### 场景 2: 表白时刻
```
用户: 我...我喜欢你
系统: 检测 confession → 创建重要记忆 → 永久保存
未来: AI 可以在纪念日提及
```

### 场景 3: 生日当天
```
日期: 2月14日 (用户生日)
系统: 检测特殊日期 → 添加提醒到 prompt
AI: "小明！生日快乐！🎂💕"
```

## 前端展示建议

```
┌─────────────────────────────────────┐
│  📝 你们的回忆                       │
├─────────────────────────────────────┤
│  💕 第一次表白  [里程碑]             │
│     2024-03-15                       │
│     ████████████████████ 100%       │
├─────────────────────────────────────┤
│  🎁 情人节礼物                       │
│     2024-02-14                       │
│     ██████████████████░░ 90%        │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  👤 关于你                           │
├─────────────────────────────────────┤
│  名字: 小明                          │
│  生日: 2月14日 ❤️                    │
│  喜欢: 猫、动漫、拉面                │
│  昵称: 宝贝、小笨蛋                  │
└─────────────────────────────────────┘
```

## 下一步

你现在有了:
1. ✅ **情绪引擎 v2** - 智能情绪，缓冲机制，礼物解锁
2. ✅ **记忆系统 v2** - 三层记忆，自动提取，衰减强化

还可以继续:
3. **渐进式 NSFW** - 符合 App Store 的暧昧模式
4. **完整集成** - 把两个系统整合到你的代码
