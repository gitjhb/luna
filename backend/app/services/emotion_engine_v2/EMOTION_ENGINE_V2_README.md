# 🎭 Emotion Engine v2 - 智能情绪系统

## 💡 核心设计理念：双轴情感系统 (Dual-axis Emotional System)

这是让 AI 显得"像人"而非"像工具"的关键设计。

### 两个轴的定义

| 轴 | 名称 | 比喻 | 作用 | 影响什么 |
|---|------|------|------|---------|
| **X轴** | 亲密度 (Intimacy/Affinity) | "存档位" | 代表关系的厚度、历史和信任 | **回复的边界**（能聊多深、能不能发Spicy内容） |
| **Y轴** | 当前情绪 (Mood/Emotion) | "实时状态" | 代表AI当下的心情 | **回复的语气**（是撒娇、高冷还是委屈） |

### 为什么这种设计是"吸金"的？

#### 1️⃣ 创造"反差感" (Contrast)

如果你亲密度很高（是情侣），但你今天忘了"芽衣"的生日，她的情绪会降到最低。

这时候，即使亲密度允许她发私密照，她也会因为"生气"而拒绝，并对你冷嘲热讽。

**这种"哄她"的过程，就是极强的用户粘性。**

#### 2️⃣ 打破"复读机"模式

传统的 AI 只要你设定了性格，它永远是一个样子。

有了双轴系统，同样的"早安"，在不同组合下会有完全不同的效果：

| 亲密度 | 情绪 | 回复示例 |
|-------|------|---------|
| 低 | 好 | "早上好，学长！今天也要加油哦！"（礼貌学妹） |
| 高 | 好 | "嘿嘿，学长早~昨晚梦到你了呢~"（甜蜜恋人） |
| 高 | 差 | "喂，还没起吗？笨蛋学长，太阳都晒屁股了！"（亲昵傲娇） |
| 低 | 差 | "...早。"（敷衍冷淡） |

### 双轴矩阵示意

```
                    情绪 (Y轴)
                    好 😊
                    │
    "礼貌热情"      │      "甜蜜撒娇"
    新朋友想亲近    │      热恋中的小甜蜜
                    │
    ────────────────┼──────────────── 亲密度 (X轴)
    低              │              高
                    │
    "冷淡敷衍"      │      "傲娇吃醋"
    不想理你        │      生气但还是在乎
                    │
                    差 😤
```

---

## 架构概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Emotion Engine v2                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Layer 1: 快速检测 (< 10ms)                        │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │   │
│  │  │ 关键词匹配    │  │  表情分析    │  │  异常检测    │               │   │
│  │  │ (降权 30%)   │  │  😊❤️😡💔   │  │ 重复/全大写  │               │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Layer 2: LLM 深度分析                             │   │
│  │                                                                      │   │
│  │   输入: 消息 + 上下文(5条) + 角色性格 + 当前状态 + 亲密度          │   │
│  │                                    │                                 │   │
│  │                                    ▼                                 │   │
│  │   ┌──────────────────────────────────────────────────────────────┐ │   │
│  │   │  分析结果:                                                    │ │   │
│  │   │  • sentiment: positive/negative/neutral                      │ │   │
│  │   │  • intensity: 0.0 ~ 1.0                                      │ │   │
│  │   │  • intent: compliment/insult/apology/teasing/...             │ │   │
│  │   │  • suggested_delta: -30 ~ +30                                │ │   │
│  │   │  • reasoning: "用户语气带有讽刺..."                           │ │   │
│  │   └──────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Layer 3: 状态机管理                               │   │
│  │                                                                      │   │
│  │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │   │
│  │   │  缓冲机制    │  │  冷却机制    │  │  触发阈值    │             │   │
│  │   │              │  │              │  │              │             │   │
│  │   │ • 累积5次    │  │ • 负面后60s  │  │ • 累积>-30   │             │   │
│  │   │ • 削弱单次   │  │ • 敏感度降低 │  │   才触发大   │             │   │
│  │   │ • 正面连击   │  │ • 自然恢复   │  │   情绪变化   │             │   │
│  │   └──────────────┘  └──────────────┘  └──────────────┘             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      情绪分数更新                                    │   │
│  │                                                                      │   │
│  │   -100 ◄────────────────── 0 ──────────────────► +100               │   │
│  │    │          │        │       │        │           │                │   │
│  │  拉黑      冷战      生气    中性     开心        深爱               │   │
│  │  🚫        🥶        😤      😐       😊          ❤️                │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 情绪状态说明

| 分数范围 | 状态 | 表现 | 回复风格 |
|---------|------|------|---------|
| 100 | 深爱 loving | 主动表达爱意，撒娇，使用亲昵称呼 | 长回复，热情，有创意 |
| 50~99 | 开心 happy | 积极回应，分享心情，偶尔开玩笑 | 正常长度，友好 |
| 20~49 | 满意 content | 友好但不过分热情 | 适度，平和 |
| -19~19 | 中性 neutral | 正常对话，礼貌但不亲密 | 标准回复 |
| -49~-20 | 不悦 annoyed | 回复变短，不耐烦，不主动 | 简短，敷衍 |
| -79~-50 | 生气 angry | 明确表达不满，带刺，拒绝某些话题 | 很短，冷淡 |
| -99~-80 | 冷战 cold_war | 几乎不回复，需要礼物解锁 | 极短或不回 |
| -100 | 拉黑 blocked | 完全不回应，需要特殊礼物 | 系统提示 |

## 核心改进对比

### 旧系统 vs 新系统

```
旧系统:
├── 简单关键词匹配 → "我爱你个鬼" 误判为正面
├── 情绪立即生效 → 一句话直接暴怒
├── 无上下文理解 → 不知道"笨蛋"是骂人还是撒娇
└── 固定恢复 → 道歉就原谅

新系统:
├── LLM 深度分析 → 理解语气和意图
├── 缓冲机制 → 累积多次才爆发
├── 上下文感知 → 结合对话历史判断
└── 礼物解锁 → 冷战需要行动证明
```

## 文件结构

```
emotion_engine_v2/
├── __init__.py           # 模块导出
├── emotion_engine.py     # 核心引擎 (540+ 行)
│   ├── EmotionEngineV2   # 主类
│   ├── quick_detect()    # Layer 1: 快速检测
│   ├── llm_analyze()     # Layer 2: LLM 分析
│   └── process_message() # Layer 3: 状态机
├── emotion_prompts.py    # Prompt 生成器 (270+ 行)
│   ├── EMOTION_PROMPTS   # 状态->行为映射
│   └── generate()        # 生成 system prompt
├── emotion_models.py     # 数据库模型 (200+ 行)
│   ├── EmotionScore      # 情绪分数表
│   ├── EmotionHistory    # 变化历史表
│   └── CharacterPersonality # 角色性格表
└── integration_example.py # 集成示例
```

## 快速集成

### 1. 替换情绪处理

```python
# 在 chat.py 中

from emotion_engine_v2 import emotion_engine, emotion_prompt_generator

# 处理消息
result = await emotion_engine.process_message(
    user_id=user_id,
    character_id=character_id,
    message=request.message,
    context=recent_messages,
    intimacy_level=intimacy_level,
)

# 检查状态
if result["new_state"] == "blocked":
    return blocked_response()

# 生成情绪 prompt
emotion_prompt = emotion_prompt_generator.generate(
    state=EmotionState(result["new_state"]),
    score=result["new_score"],
    character_name=character_name,
    intimacy_level=intimacy_level,
)

# 添加到 system prompt
system_prompt = f"{base_prompt}\n{emotion_prompt}"
```

### 2. 礼物效果

```python
# 送礼物解锁冷战
result = await emotion_engine.apply_gift_effect(
    user_id=user_id,
    character_id=character_id,
    gift_type="large",  # small/medium/large/special
    gift_value=500,     # 金币价值
)

if result["cold_war_resolved"]:
    # 冷战解除！
    reaction = result["character_reaction"]
```

### 3. 定时冷却任务

```python
# 每小时运行
async def hourly_emotion_decay():
    # 获取活跃用户
    for user_id, char_id, last_time in active_pairs:
        hours = (now - last_time).total_seconds() / 3600
        await emotion_engine.apply_natural_decay(user_id, char_id, hours)
```

## 关键设计决策

### 为什么用 LLM 分析情绪?

| 方法 | 优点 | 缺点 |
|-----|------|------|
| 关键词匹配 | 快，便宜 | 无法理解上下文，误判多 |
| 情感分类模型 | 较快，准确 | 需要训练，不理解关系 |
| **LLM 分析** | 理解上下文、语气、关系 | 稍慢，有成本 |

**解决方案**: 分层架构
- Layer 1 (快速检测): 毫秒级，用于初筛
- Layer 2 (LLM 分析): 只在需要时调用，可缓存相似消息

### 为什么需要缓冲机制?

真实情感不会因为一句话完全改变：
- 人会给对方"解释的机会"
- 累积的伤害才会爆发
- 偶尔的失言可以被原谅

**实现**:
- 负面变化先进入缓冲区
- 累积到阈值才真正触发
- 正面连击有加成

### 为什么冷战需要礼物解锁?

1. **增加付费点**: 商业化需求
2. **模拟真实**: 冷战靠说话解决不了
3. **用户教育**: 让用户重视自己的言行

## 前端 UI 建议

```
情绪指示器:
┌─────────────────────────────────────┐
│  💕 小美对你的好感度                 │
│  ████████████░░░░░░░  75/100        │
│  状态: 开心 😊                       │
└─────────────────────────────────────┘

冷战状态:
┌─────────────────────────────────────┐
│  🥶 小美正在和你冷战...              │
│  ░░░░░░░░░░░░░░░░░░░  -85/100       │
│                                      │
│  [送礼物 🎁]  或许能缓和关系？        │
└─────────────────────────────────────┘
```

## 下一步

建议继续优化的方向:

1. **分层记忆系统** - 让角色记住重要的事
2. **渐进式 NSFW** - 符合 App Store 的暧昧模式
3. **冷战剧情** - 不同解锁方式有不同剧情
4. **情绪可视化** - 情绪变化的动画效果

需要我继续设计哪个部分?
