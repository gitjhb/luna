# Embedding 成本分析

## 模型价格对比 (2024-2025)

| 模型 | 价格 (per 1M tokens) | 维度 | 质量 | 推荐 |
|------|---------------------|------|------|------|
| **text-embedding-3-small** | $0.02 | 1536 | 好 | ✅ 最佳性价比 |
| text-embedding-3-large | $0.13 | 3072 | 更好 | 大规模/高精度 |
| text-embedding-ada-002 | $0.10 | 1536 | 好 | 旧版，不推荐 |
| Voyage AI | ~$0.02 | 1024 | 好 | 备选 |
| Cohere embed-v3 | ~$0.10 | 1024 | 好 | 备选 |
| BGE / E5 (自托管) | 免费 | 1024 | 好 | 需要 GPU |

**结论：用 `text-embedding-3-small`，$0.02/1M tokens，够用了。**

---

## 场景估算

### 假设
- 1 条消息 ≈ 50 tokens（中英文平均）
- 1 条记忆 ≈ 30 tokens（提炼后更短）
- 1 次召回 query ≈ 50 tokens

### 策略 A：每条消息都存（不推荐）

| 规模 | 日消息量 | 日 embedding tokens | 日成本 | 月成本 |
|------|----------|---------------------|--------|--------|
| 100 用户 | 10,000 条 | 500K | $0.01 | $0.30 |
| 1,000 用户 | 100,000 条 | 5M | $0.10 | $3.00 |
| 10,000 用户 | 1,000,000 条 | 50M | $1.00 | $30.00 |
| 100,000 用户 | 10,000,000 条 | 500M | $10.00 | $300.00 |

**问题：向量库存储成本也会爆炸（Pinecone 按向量数收费）**

---

### 策略 B：只存提取的记忆（推荐 ✅）

假设：每 10 条对话提取 1 条记忆

| 规模 | 日消息量 | 日记忆提取 | embedding tokens | 日成本 | 月成本 |
|------|----------|-----------|------------------|--------|--------|
| 100 用户 | 10,000 条 | 1,000 条 | 30K | $0.0006 | $0.02 |
| 1,000 用户 | 100,000 条 | 10,000 条 | 300K | $0.006 | $0.18 |
| 10,000 用户 | 1,000,000 条 | 100,000 条 | 3M | $0.06 | $1.80 |
| 100,000 用户 | 10,000,000 条 | 1,000,000 条 | 30M | $0.60 | $18.00 |

**便宜 10 倍！而且向量库存储也少 10 倍。**

---

### 召回成本（每次对话都要）

| 规模 | 日对话次数 | 召回 query tokens | 日成本 | 月成本 |
|------|-----------|-------------------|--------|--------|
| 100 用户 | 5,000 次 | 250K | $0.005 | $0.15 |
| 1,000 用户 | 50,000 次 | 2.5M | $0.05 | $1.50 |
| 10,000 用户 | 500,000 次 | 25M | $0.50 | $15.00 |
| 100,000 用户 | 5,000,000 次 | 250M | $5.00 | $150.00 |

---

## 总成本估算（策略 B）

**假设：1,000 用户，每人每天 100 条消息**

| 项目 | 日成本 | 月成本 |
|------|--------|--------|
| 记忆 embedding (10,000 条) | $0.006 | $0.18 |
| 召回 query (50,000 次) | $0.05 | $1.50 |
| **Embedding 总计** | **$0.056** | **$1.68** |
| 记忆提取 LLM (gpt-4o-mini) | ~$0.50 | ~$15.00 |
| 向量库存储 (Pinecone) | - | ~$10.00 |
| **总计** | | **~$27/月** |

**对比收入：1,000 用户 × $10/月订阅 = $10,000/月**
**利润率：99.7%** 🤑

---

## 优化策略

### 1. 缓存热门记忆
```python
# Redis 缓存最近召回的记忆
cache_key = f"memory:{user_id}:recent"
cached = await redis.get(cache_key)
if cached:
    return json.loads(cached)  # 省掉 embedding 调用
```

### 2. 批量 embedding
```python
# 不要一条一条调，攒一批再调
texts = [m.content for m in memories_to_embed]
embeddings = await openai.embeddings.create(
    model="text-embedding-3-small",
    input=texts  # 批量
)
```

### 3. 延迟 embedding（异步队列）
```python
# 对话结束后丢进队列，不阻塞响应
await queue.enqueue("embed_memories", user_id=user_id, memories=memories)
```

### 4. 本地模型（超大规模）
- 用 BGE-small / E5-small 自托管
- 一次性部署成本，后续免费
- 需要 GPU，适合 >10 万用户规模

---

## 结论

| 方案 | 成本 | 推荐场景 |
|------|------|----------|
| 每条消息存向量 | $300/月/10万用户 | ❌ 不推荐 |
| **只存提取记忆** | **$18/月/10万用户** | ✅ 大多数场景 |
| 自托管 embedding | 一次性 GPU 成本 | 超大规模/敏感数据 |

**用 text-embedding-3-small + 只存记忆 = 最佳性价比**
