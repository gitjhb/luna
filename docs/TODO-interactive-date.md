# äº’åŠ¨å¼çº¦ä¼šç³»ç»Ÿ - Interactive Date System

> ç±»ä¼¼ã€Šå¿ƒè·³å›å¿†ã€‹çš„äº’åŠ¨å¼å‰§æƒ…çº¦ä¼šï¼Œç”¨æˆ·åšé€‰æ‹©å½±å“ç»“å±€

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

- **æ²‰æµ¸å¼åœºæ™¯**ï¼šä¸æ˜¯èŠå¤©æ¡†ï¼Œæ˜¯å…¨å±å‰§æƒ…ç•Œé¢
- **åˆ†æ”¯é€‰æ‹©**ï¼šæ¯ä¸ªé˜¶æ®µ 2-3 ä¸ªé€‰é¡¹ï¼Œå½±å“å‰§æƒ…èµ°å‘
- **åŠ¨æ€ç”Ÿæˆ**ï¼šLLM å®æ—¶ç”Ÿæˆå‰§æƒ…ï¼Œä¸å¯é¢„æµ‹
- **å¤šç»“å±€**ï¼šå¥½/æ™®é€š/åç»“å±€ï¼Œå½±å“ XP å’Œå›å¿†
- **Cooldown**ï¼šçº¦ä¼šæœ‰å†·å´æ—¶é—´ï¼Œå¢åŠ ç¨€ç¼ºæ€§

## ğŸ“Š ç»“å±€ç³»ç»Ÿ

| ç»“å±€ | XP | å¥½æ„Ÿåº¦ | æ¡ä»¶ |
|------|-----|--------|------|
| ğŸ’• å®Œç¾ | 100 | +20 | å…³é”®é€‰æ‹©æ­£ç¡® + é«˜äº’åŠ¨ |
| ğŸ˜Š è‰¯å¥½ | 50 | +10 | å¤§éƒ¨åˆ†æ­£ç¡® |
| ğŸ˜… æ™®é€š | 20 | +5 | ä¸€èˆ¬è¡¨ç° |
| ğŸ’” ç³Ÿç³• | 5 | -5 | è¸©é›·/å†·åœº |

## ğŸ—„ï¸ æ•°æ®ç»“æ„

```python
class DateSession:
    id: str
    user_id: str
    character_id: str
    scenario_id: str
    
    # é˜¶æ®µè®°å½•
    stages: List[DateStage]  # çº¦ 5 ä¸ªé˜¶æ®µ
    current_stage: int
    
    # çŠ¶æ€è¿½è¸ª
    affection_score: int  # ç´¯è®¡å¥½æ„Ÿå˜åŒ– (-100 ~ +100)
    status: "in_progress" | "completed" | "abandoned"
    
    # ç»“æœ
    ending_type: "perfect" | "good" | "normal" | "bad" | None
    xp_awarded: int
    story_summary: str  # æœ€ç»ˆå›å¿†æ–‡æœ¬
    
    # æ—¶é—´
    started_at: datetime
    completed_at: datetime
    cooldown_until: datetime

class DateStage:
    stage_num: int
    narrative: str  # å‰§æƒ…æè¿°
    options: List[DateOption]  # 2-3 ä¸ªé€‰é¡¹
    user_choice: int | None  # ç”¨æˆ·é€‰æ‹©çš„é€‰é¡¹ index
    affection_change: int  # è¿™ä¸ªé˜¶æ®µçš„å¥½æ„Ÿå˜åŒ–
    timestamp: datetime

class DateOption:
    text: str  # é€‰é¡¹æ–‡æœ¬
    type: "good" | "neutral" | "bad"  # é€‰é¡¹ç±»å‹ï¼ˆLLM åˆ¤æ–­ï¼‰
```

## ğŸ”Œ API è®¾è®¡

### POST /dates/start
å¼€å§‹æ–°çº¦ä¼šï¼Œè¿”å›ç¬¬ä¸€ä¸ªé˜¶æ®µ

```json
Request:
{
  "character_id": "sakura",
  "scenario_id": "cafe_paris"
}

Response:
{
  "success": true,
  "session_id": "uuid",
  "stage": {
    "stage_num": 1,
    "narrative": "é˜³å…‰é€è¿‡å’–å•¡å…çš„ç»ç’ƒçª—æ´’è½...",
    "character_expression": "shy",  // è§’è‰²è¡¨æƒ…
    "options": [
      { "id": 0, "text": "ã€Œè¿™å®¶åº—æ°›å›´çœŸå¥½ï¼Œä½ ç»å¸¸æ¥å—ï¼Ÿã€" },
      { "id": 1, "text": "ã€Œç‚¹æ¯å’–å•¡å§ï¼Œä½ å–œæ¬¢ä»€ä¹ˆå£å‘³ï¼Ÿã€" },
      { "id": 2, "text": "ï¼ˆé»˜é»˜çœ‹ç€çª—å¤–å‘å‘†ï¼‰" }
    ]
  },
  "progress": { "current": 1, "total": 5 }
}
```

### POST /dates/choose
æäº¤é€‰æ‹©ï¼Œè·å–ä¸‹ä¸€é˜¶æ®µ

```json
Request:
{
  "session_id": "uuid",
  "choice_id": 1
}

Response:
{
  "success": true,
  "affection_change": +10,
  "stage": {
    "stage_num": 2,
    "narrative": "Sakura çœ¼ç›ä¸€äº®...",
    ...
  },
  "progress": { "current": 2, "total": 5 }
}
```

### POST /dates/complete
æœ€åé˜¶æ®µåè°ƒç”¨ï¼Œè®¡ç®—ç»“å±€

```json
Response:
{
  "success": true,
  "ending": {
    "type": "perfect",
    "title": "å®Œç¾çš„ä¸‹åˆ",
    "description": "è¿™æ˜¯ä¸€æ¬¡éš¾å¿˜çš„çº¦ä¼š..."
  },
  "rewards": {
    "xp": 100,
    "affection": +20,
    "achievement": "first_perfect_date"
  },
  "story_summary": "åœ¨å·´é»å’–å•¡å…çš„åˆå...",  // ä¿å­˜åˆ°å›å¿†å½•
  "cooldown_hours": 24
}
```

### GET /dates/status
æ£€æŸ¥å†·å´å’Œå½“å‰è¿›è¡Œä¸­çš„çº¦ä¼š

```json
Response:
{
  "can_date": false,
  "cooldown_until": "2024-01-15T10:00:00Z",
  "cooldown_remaining_minutes": 120,
  "active_session": null | { session_id, stage_num }
}
```

## ğŸ¤– LLM Prompt æ¶æ„ï¼ˆä¸‰å±‚è®¾è®¡ï¼‰

### æ ¸å¿ƒåŸåˆ™
- **æ•°å€¼æ˜¯æ ¸å¿ƒ**ï¼šå¥½æ„Ÿåº¦æ˜¯æ•°æ®åº“é‡Œçš„æ•´æ•°å˜é‡
- **AIæ˜¯ç¿»è¯‘å®˜**ï¼šAI æ ¹æ®æ•°å€¼"ç¿»è¯‘"æˆåˆé€‚çš„å¯¹è¯å†…å®¹
- **é˜²æ­¢æ•°å€¼å´©å**ï¼šç³»ç»ŸåŠ æ ¡éªŒå±‚ï¼Œå•æ¬¡å˜åŠ¨ä¸è¶…è¿‡ Â±15ï¼ˆç‰¹æ®Š +25ï¼‰

### Prompt ä¸‰å±‚ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: Personaï¼ˆè§’è‰²çµé­‚ï¼‰         â”‚
â”‚ - è§’è‰²åå­—ã€æ€§æ ¼ã€è¯´è¯æ–¹å¼           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 2: Rulesï¼ˆè§„åˆ™çº¦æŸï¼‰           â”‚
â”‚ - ä¸è¦è·³å‡ºè§’è‰²                       â”‚
â”‚ - å¿…é¡»è¿”å› JSON æ ¼å¼                 â”‚
â”‚ - affection èŒƒå›´é™åˆ¶                 â”‚
â”‚ - é€‰é¡¹ç±»å‹è¦æ±‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 3: State Snapshotï¼ˆæ¸¸æˆå¿«ç…§ï¼‰  â”‚
â”‚ {                                   â”‚
â”‚   "stage": 2,                       â”‚
â”‚   "affection": 65,                  â”‚
â”‚   "attitude_mode": "æš§æ˜§æ¨¡å¼",       â”‚
â”‚   "location": "å’–å•¡å…",              â”‚
â”‚   "player_history": ["é€‰äº†ä¹¦åŒ…",...]â”‚
â”‚   "last_action": "å¤¸å¥¹å¯çˆ±"          â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ€åº¦æ¨¡å¼æ˜ å°„
| å¥½æ„Ÿåº¦ | æ€åº¦æ¨¡å¼ | è§’è‰²è¡¨ç° |
|--------|----------|----------|
| 70+ | çƒ­æ‹æ¨¡å¼ | æ’’å¨‡ã€è„¸çº¢ã€è¯´ç”œèœœçš„è¯ |
| 50-69 | æš§æ˜§æ¨¡å¼ | å®³ç¾ã€å¼€ç©ç¬‘ã€å¶å°”è°ƒæƒ… |
| 30-49 | å¥½æ„Ÿæ¨¡å¼ | å‹å¥½ã€æ„¿æ„äº²è¿‘ã€å¶å°”å¾®ç¬‘ |
| 10-29 | ä¸­ç«‹æ¨¡å¼ | ç¤¼è²Œä½†ä¿æŒè·ç¦» |
| 0-9 | å†·æ·¡æ¨¡å¼ | æ•·è¡ã€å›åº”ç®€çŸ­ |
| <0 | åŒçƒ¦æ¨¡å¼ | ä¸è€çƒ¦ã€æƒ³å¿«ç‚¹ç»“æŸ |

### æ•°å€¼æ ¡éªŒå±‚
```python
# æ™®é€šé€‰é¡¹ï¼š-15 åˆ° +15
validated = max(-15, min(15, raw_affection))

# ç‰¹æ®Šé€‰é¡¹ï¼š-15 åˆ° +25
validated = max(-15, min(25, raw_affection))
```

## ğŸ¨ å‰ç«¯ UI è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [èƒŒæ™¯å›¾ï¼šå’–å•¡å…åœºæ™¯]                â”‚
â”‚                                     â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚         â”‚ è§’è‰²ç«‹ç»˜ â”‚                 â”‚
â”‚         â”‚ (è¡¨æƒ…å˜åŒ–)â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ é˜³å…‰é€è¿‡å’–å•¡å…çš„ç»ç’ƒçª—æ´’è½ï¼Œ    â”‚ â”‚
â”‚ â”‚ Sakura ååœ¨ä½ å¯¹é¢ï¼Œæœ‰äº›ç´§å¼ åœ°   â”‚ â”‚
â”‚ â”‚ æ‘†å¼„ç€é¢å‰çš„é¤å·¾...             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚  â—‹ â—‹ â— â—‹ â—‹  (è¿›åº¦: 3/5)            â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ã€Œè¿™å®¶åº—æ°›å›´çœŸå¥½ã€               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ã€Œç‚¹æ¯å’–å•¡å§ã€                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ï¼ˆé»˜é»˜çœ‹çª—å¤–ï¼‰                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“… å¼€å‘è®¡åˆ’

### Phase 1: åç«¯ API æ¡†æ¶ âœ… å®Œæˆ
- [x] DateSession æ•°æ®æ¨¡å‹ (`interactive_date_service.py`)
- [x] /dates/interactive/start API
- [x] /dates/interactive/choose API  
- [x] /dates/status API (å« cooldown)
- [x] /dates/interactive/abandon API
- [x] Cooldown é€»è¾‘ (24h æ™®é€š, 12h æ”¾å¼ƒ)

### Phase 2: LLM å‰§æƒ…ç”Ÿæˆ âœ… åŸºç¡€å®Œæˆ
- [x] Prompt æ¨¡æ¿è®¾è®¡ (5é˜¶æ®µç»“æ„)
- [x] å‰§æƒ…è¿è´¯æ€§ (ä¼ é€’ previous_stages)
- [x] é€‰é¡¹å¹³è¡¡ (good/neutral/bad ç±»å‹)
- [x] ç»“å±€åˆ¤å®š (affection é˜ˆå€¼: 60/30/0)
- [ ] Prompt è°ƒä¼˜æµ‹è¯• (éœ€è¦å®é™…è·‘å‡ è½®çœ‹æ•ˆæœ)

### Phase 3: å‰ç«¯æ²‰æµ¸å¼ UI âœ… åŸºç¡€å®Œæˆ
- [x] DateSceneModal ç»„ä»¶ (`DateSceneModal.tsx`)
- [x] èƒŒæ™¯æ¸å˜ (åœºæ™¯å¯¹åº”é¢œè‰²)
- [x] é€‰é¡¹åŠ¨ç”»æ•ˆæœ (fade + slide)
- [x] ç»“å±€æ¼”å‡º (å¥–åŠ±å±•ç¤º)
- [ ] è§’è‰²ç«‹ç»˜ç³»ç»Ÿ (åç»­)
- [ ] èƒŒæ™¯å›¾ç‰‡èµ„æº (åç»­)

### Phase 4: æˆå°±ç³»ç»Ÿé›†æˆ âœ… åŸºç¡€å®Œæˆ
- [x] çº¦ä¼šç›¸å…³æˆå°±ï¼ˆperfect_date, bad_dateï¼‰
- [x] å›å¿†å½•é›†æˆï¼ˆä¿å­˜åˆ° event_memoriesï¼‰
- [x] è§’è‰²å¥½æ„Ÿåº¦å½±å“ï¼ˆemotion_engine.update_scoreï¼‰
- [ ] å®Œæ•´æˆå°±ç³»ç»Ÿï¼ˆåç»­è¿­ä»£ï¼‰

## ğŸ’¡ å•†ä¸šåŒ–è€ƒè™‘

- **Cooldown è·³è¿‡**ï¼šæ¶ˆè€—æœˆçŸ³
- **é‡ç©çº¦ä¼š**ï¼šVIP åŠŸèƒ½
- **ç‰¹æ®Šåœºæ™¯**ï¼šä»˜è´¹è§£é”
- **æ”¶è—å›å¿†**ï¼šå¯¼å‡º/åˆ†äº«åŠŸèƒ½
